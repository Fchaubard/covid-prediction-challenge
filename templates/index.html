<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta content="initial-scale=1, shrink-to-fit=no, width=device-width" name="viewport">
  <title>COVID-19 Prediction Challenge</title>
  <link rel="icon" type="image/png" href="/static/images/favicon.ico" />
  <link href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,500,500i,700,700i|Roboto+Mono:300,400,700|Roboto+Slab:300,400,700" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/bootstrap-material-design@4.1.1/dist/css/bootstrap-material-design.min.css" integrity="sha384-wXznGJNEXNG1NFsbm0ugrLFMQPWswR3lds2VeinahP8N0zJw9VWSopbjv2x7WCvX" crossorigin="anonymous">
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <link href="  https://pagination.js.org/dist/2.0.7/pagination.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.10/css/select2.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-124148774-3"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-124148774-3');
  </script>

<style>
  a {color:#FF8484 }
  .primary-bg{
    background-color:rgb(53, 35, 74)
    }
  .header{
    background-color: #D84C73; 
    display: flex;
    align-items: center;
    justify-content: center;
    }
  .row{
    margin:0
    }
  .column{
    flex-direction:column
    }
.pagination li {
  padding:5px;
  margin: 3px;
}
.pagination{
  display: flex;
  align-items: center;
  justify-content: center;
}


.select2-selection__rendered {
  line-height: 45px !important;
}
.select2-container .select2-selection--single {
  height: 45px !important;
}
.select2-selection__arrow {
  height: 45px !important;
}
.select2-selection__rendered {font-weight: bold;
  text-align: center;
  font-size: 17px;
  text-transform: uppercase;
}
.select2-container--default .select2-selection--single {
  background-color: #fff;
  border: 1px solid #aaa;
  border-radius: 5px 5px 0px 0px;

}

.select2-container--default .select2-selection--single .select2-selection__arrow b {
  border-color: #888 transparent transparent transparent;
  border-style: solid;
  border-width: 8px 8px 0 8px;
  height: 0;
  left: 50%;
  margin-left: -14px;
  margin-top: -3px;
  position: absolute;
  top: 50%;
  width: 0;
}

.select2-container--default.select2-container--open .select2-selection--single .select2-selection__arrow b {
  border-color: transparent transparent #888 transparent;
  border-width: 0 8px 8px 8px;
}

  </style>
</head>

<!-- Navbar -->
<section>
<nav class="navbar navbar-expand-lg navbar-dark primary-bg">
  <a class="navbar-brand" style="width:150px" href="#">
    <img class="w-100" style="padding:10px" src="static/images/logo_light.png">
  </a>
  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>
  <div class="collapse navbar-collapse" id="navbarNav">
    <ul class="navbar-nav">
      <li class="nav-item active">
        <a class="nav-link" href="/">Predictions</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="/submit">Submit a Prediction</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/about">About</a>
      </li>
    </ul>
  </div>
</nav>
</section>
<!-- Navbar End -->

<!-- Body -->
<body>


<!-- Leaderboard Section -->

<section class="mt-4">
  <div class="col-sm-12">
    <div class="card">
      <div class="header">
        <h4 class="card-title m-0 p-2 text-white font-weight-bold text-uppercase">COVID-19 Prediction Leaderboard</h4>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-sm-6">
              <div class="col-sm-12" id='leaderboard'>
                <select style="width:100%" class="region-picker" name="region"></select>
            <!-- <input type="text" class="fuzzy-search w-100" placeholder="Search..." /> -->
            <div class="d-flex justify-content-between align-items-center" style="width:100%;padding: 10px; background-color: #5C3B6F; color:white">
              <p class="name" style="text-align:center; margin-bottom:0; margin:0px; width:25%">SUBMISSION NAME</p>
              <p class="name" style="text-align:center; margin-bottom:0; margin:0px; width:25%">SUBMISSION LINK</p>
              <p class="name" style="text-align:center; margin-bottom:0; margin:0px; width:25%">DAYS SCORED</p>
              <p class="name" style="text-align:center; margin-bottom:0; margin:0px; width:25%">SCORE</p>
          </div>
            <ul class="list-group list" id='' style="cursor:pointer; padding-top:0px"></ul>
            <ul class="pagination"></ul>
          </div>
          </div>
          <div class="col-sm-6">
            <div id="leaderboard-plot" style="width:100%"></div>
          </div>
        </div>      
      </div>
    </div>
  </div>
</section>
<!-- Leaderboard Section End-->

<script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
<script src="https://unpkg.com/popper.js@1.12.6/dist/umd/popper.js" integrity="sha384-fA23ZRQ3G/J53mElWqVJEGJzU0sTs+SvzG8fXVWP+kJQ1lwFAOkcUOysnlKJC33U" crossorigin="anonymous"></script>
<script src="https://unpkg.com/bootstrap-material-design@4.1.1/dist/js/bootstrap-material-design.js" integrity="sha384-CauSuKpEqAFajSpkdjv3z9t8E7RlpJ1UP0lKM/+NdtSarroVKu069AlsRPKkFBz9" crossorigin="anonymous"></script>
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/list.js/1.5.0/list.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.10/js/select2.min.js"></script>
<script>

var leaderboardList 

// Function to generate plotly truth vs. predicition plot. Gets passed dates and data per day for both predictions and truth data. 
function createPlot (truthX, truthY, predictionX, predictionY) {
    truth = {
    type: 'scatter',
    x: truthX,
    y: truthY,
    mode: 'markers',
    name: 'WHO Truth Data',
    marker: {
      color: 'rgba(156, 165, 196, 0.95)',
      symbol: 'circle',
      size: 16
    }
  };

  prediction = {
    type: 'scatter',
    x: predictionX,
    y: predictionY,
    mode: 'lines',
    name: 'Most Accurate Prediction',
    line: {
      color: '#5C3B6F',
      width: 2
    }
  };

  var layout = {
    title: 'Global Deaths: Truth vs. Prediction',
      responsive: true,
      hovermode: 'closest',
      legend: {
        font: {
          size: 10,
        },
      yanchor: 'middle',
      xanchor: 'right',
      },
  };

  var data = [truth, prediction];

  Plotly.newPlot('leaderboard-plot', data, layout);
  }



$(document).ready(function() {

  // Get leaderboard.json and create leaderboard table, filter and graph
  $.get('/get/leaderboard', function (response) {
    var leaderboard = JSON.parse(response)

    // Create leaderboard table object with list.js
    var values
    var options = {
        valueNames: ['name', 'link', 'score', 'days_scored', 'id'],
        item: `<li class="list-group-item entry" style="padding:0; display:flex; border-right: solid 1px #5C3B6F; border-bottom: solid 1px #5C3B6F; border-left: solid 1px #5C3B6F;padding: 10px">
                <div class="d-flex justify-content-center align-items-center" style="width: 100%; margin:0">
                  <p class="name" style="text-align:center; margin:0; width:25%"></p>
                <div class="link w-25 text-center"></div>
                <div class="days_scored w-25 text-center"></div>
                <div class="score w-25 text-center"></div>
                <div class="id" style="display:none"></div>
              </div>
              </li>`,
        pagination: true,
        page: 10,
    };
    leaderboardList = new List('leaderboard', options, values);

    // Add entries to leaderboard table
    $.each(leaderboard.Predictions, function (k, prediction) {
      var scores = JSON.stringify(prediction.scores)
      leaderboardList.add({
              name: prediction.submission_name,
              link: `<a style="margin:0" href="${prediction.source}">Link</a>`,
              id: k, 
              score: 1, //dummy value, gets overwritten once a region is selected
              days_scored: prediction.days_scored,
      })
    })

    // Create region picker object
    $.each(leaderboard.Truth, function (k, region) {
      if (k != 'Dates'){
        $('.region-picker').append('<option value="' + k + '">' + k +'</option>')
      }
    })
    $('.region-picker').select2({});

    // Set World as the default selection
    $('.region-picker').val("World").trigger('change')

 
   // Filter function for list. Looks at currently selected region in picker and then checks each element in list for 
   // whether a prediction was made for the region 
    function filterCountry () {leaderboardList.filter(function(item) {
      var region = $('.region-picker').select2('data')[0].id
      if (region in leaderboard.Predictions[item.values().id].scores) {
        item.values({
            score: parseInt(leaderboard.Predictions[item.values().id].scores[region]),
        });
        return true;
      } else {
        return false;
      }
      })}

    filterCountry()

    // Sort leaderboard by score
    leaderboardList.sort('score', {
          order: "desc"
      });
    leaderboardList.update()


    // Generate plot from the leading entry in the list
    function showLeadingPlot () {
      var region = $('.region-picker').select2('data')[0].id
      var submissionId = leaderboardList.visibleItems[0]._values.id
      createPlot(leaderboard.Truth.Dates,
      leaderboard.Truth[region], 
      leaderboard.Predictions[submissionId].TimeSeries.Dates,
      leaderboard.Predictions[submissionId].TimeSeries[region]
      )
    }
    showLeadingPlot()

    
    // Run filter on region picker change
    $('.region-picker').on('select2:select', function (e) {
      filterCountry()
      showLeadingPlot()
      leaderboardList.sort('score', {
          order: "desc"
      });
     leaderboardList.update()
    })

  // Chnage plot when leaderboard entry is clicked
    $('.entry').click(function() {
      var submissionId = $(this).find('.id')[0].innerText
      var region = $('.region-picker').select2('data')[0].id
      createPlot(leaderboard.Truth.Dates,
      leaderboard.Truth[region], 
      leaderboard.Predictions[submissionId].TimeSeries.Dates,
      leaderboard.Predictions[submissionId].TimeSeries[region]
      )
    })
  })
})


</script>



</body>
<!-- Body End -->
</html>